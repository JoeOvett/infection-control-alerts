<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WinPath Source Map</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="icon" type="image/png" href="germs.png" />
</head>
<body>
    <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/map.html">Map</a></li>
          <li><a href="/prh.html">PRH</a></li>
          <li><a href="/worthing.html">Worthing</a></li>
        </ul>
      </nav>

    <div id="map"></div>
    
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMlg3335BMxPO51I7ZMpp-OXsTYCAaxYw&callback=initMap"
    async defer></script>
</body>
    <script>
function initMap() {
    const map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 50.819, lng: -0.116 },
        zoom: 8,
        maxZoom: 21,
        mapId: '8e6deb7a6acd250c',
        tilt: 45,
        heading: 0,
        isFractionalZoomEnabled: true
    });


            let infoWindow = new google.maps.InfoWindow();
            let userInteracted = false;

            map.addListener('tilesloaded', function() {
                ['mousedown', 'wheel', 'touchstart', 'dragstart'].forEach(event => 
                    map.getDiv().addEventListener(event, () => {
                        userInteracted = true;
                        stopAutomaticControls();
                    })
                );
            });
            
// Initialize the MarkerClusterer object
const markerCluster = new MarkerClusterer(map, [], {
    imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
    maxZoom: 15,  // Set maxZoom to 15 or adjust according to your needs
});


// Fetch locations from the server
fetch('https://jo435.brighton.domains/ci601/get-locations.php')
    .then(response => response.json())
    .then(locations => {
        locations.forEach(location => {
            const position = new google.maps.LatLng(parseFloat(location.Latitude), parseFloat(location.Longitude));
            const marker = new google.maps.Marker({
                position: position,
                title: location.Name, // Setting the title to Name for more clarity
                animation: google.maps.Animation.DROP
            });

            marker.addListener('click', () => {
                // Constructing content for the infoWindow
                const contentString = `
                    <div>
                        <h2>${location.Name}</h2>
                        <p><strong>Lab No:</strong> ${location.LabNo}</p>
                        <p><strong>Sex:</strong> ${location.Sex.trim()}</p>
                        <p><strong>Age:</strong> ${location.Age}</p>
                        <p><strong>Collected:</strong> ${location.Collected}</p>
                        <p><strong>Received:</strong> ${location.Received}</p>
                        <p><strong>Sample:</strong> ${location.Sample}</p>
                        <p><strong>Isolate:</strong> ${location.Isolate}</p>
                        ${[...Array(18)].map((_, i) => location[`Antibiotic${i+1}`] ? `<p><strong>Antibiotic ${i+1}:</strong> ${location[`Antibiotic${i+1}`]}</p>` : '').join('')}
                    </div>
                `;
                infoWindow.setContent(contentString);
                infoWindow.open(map, marker);
            });

            // Add the marker to the MarkerClusterer
            markerCluster.addMarker(marker);
        });
    })
    .catch(error => {
        console.error('Error fetching locations:', error);
    });

    const degreesPerSecond = 3;
    let cameraAnimationRequest;
    function animateCamera(time) {
        if (!userInteracted) {
            map.moveCamera({ heading: (time / 1000) * degreesPerSecond % 360 });
            cameraAnimationRequest = requestAnimationFrame(animateCamera);
        }
    }
    cameraAnimationRequest = requestAnimationFrame(animateCamera);

    let smoothZoomTimeout;
    function smoothZoom(map, targetZoom, currentZoom) {
        if (!userInteracted && currentZoom !== targetZoom) {
            let step = (targetZoom - currentZoom) / 50;
            smoothZoomTimeout = setTimeout(() => {
                map.setZoom(currentZoom + step);
                smoothZoom(map, targetZoom, currentZoom + step);
            }, 20);
        }
    }
    smoothZoomTimeout = setTimeout(() => smoothZoom(map, 16, map.getZoom()), 3000);

    function stopAutomaticControls() {
        cancelAnimationFrame(cameraAnimationRequest);
        clearTimeout(smoothZoomTimeout);
    }

    function toggleBounce(marker) {
        if (marker.getAnimation() !== null) {
            marker.setAnimation(null);
        } else {
            marker.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(() => marker.setAnimation(null), 1400);
        }
    }
}
    </script>
    <!-- Include the MarkerClusterer library -->

</html>